
## 2025-12-11

### â­ What I learned
- Refresh knowledge [Looked into PHP performance tricks (array operations, string ops).](https://github.com/serhii-panferov/git-tips)

### ğŸ›  What I built or improved
- Refactoring Cake PHP controllers to achieve a clean, thin-controller structure.
- Create async/wait with PHP Fiber 
  ```
    class AsyncTask {
        public ?Fiber $fiber = null;
        public $result = null;
        public $error = null;
        public bool $done = false;
        public $onComplete = null;
    }
    class Scheduler {
        private array $queue = [];
        public function async(callable $fn): AsyncTask {
            $task = new AsyncTask();
            $task->fiber = new Fiber(function () use ($fn, $task) {
                try {
                    $task->result = $fn();
                } catch (\Throwable $e) {
                    $task->error = $e;
                }
                $task->done = true;
                if ($task->onComplete) {
                    ($task->onComplete)($task);
                }
                return $task->result;
            });
    
            $this->queue[] = $task;
            return $task;
        }
        public function await(AsyncTask $task) {
            if ($task->done) {
                if ($task->error) {
                    throw $task->error;
                }
                return $task->result;
            }
    
            return Fiber::suspend($task);
        }
        public function run() {
            while ($this->queue) {
                /** @var AsyncTask $task */
                $task = array_shift($this->queue);
    
                if (!$task->fiber->isStarted()) {
                    $task->fiber->start();
                } elseif ($task->fiber->isSuspended()) {
                    $task->fiber->resume();
                }
            }
        }
    }
    $scheduler = new Scheduler();
    function delay(int $ms) {
        usleep($ms * 1000);
    }
    function asyncDelay($ms, $value) {
        global $scheduler;
        return $scheduler->async(function () use ($ms, $value) {
            delay($ms);
            return $value;
        });
    }
    function await(AsyncTask $task) {
        global $scheduler;
        return $scheduler->await($task);
    }
    $scheduler->async(function () {
        echo "Start A\n";
        $a = await(asyncDelay(500, "Result A"));
        echo "A finished: $a\n";
    
        echo "Start B\n";
        $b = await(asyncDelay(300, "Result B"));
        echo "B finished: $b\n";
    });
    $scheduler->run();
  ```

### ğŸ” Notes / Discoveries
Outcomes:
```
Start A
A finished: Result A
Start B
B finished: Result B
```
### ğŸ¯ Next small step
Small steps have a bigger impact in the long run
